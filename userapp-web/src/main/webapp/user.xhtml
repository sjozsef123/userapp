<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui">

<h:head>
	<f:metadata>
		<f:viewAction action="#{loginmanagedbean.isAdmin()}" />
	</f:metadata>
	<title>#{msg['web.user.title']}</title>
</h:head>

<h:body>
	<p:messages id="messages" showDetail="false" autoUpdate="true"
		closable="true" />
	<h:panelGrid id="panel" columns="2" cellpadding="10">
		<h:column>
			<ui:include src="/includes/navigation.xhtml" />
		</h:column>

		<h:column>
			<h:form id="form1">
				<p:growl id="messages" showDetail="true" />
				<p:panel header="#{msg['web.user.adduser']}">


					<p:panelGrid columns="6">

						<h:column>
							<h:outputLabel for="username" value="#{msg['web.user.name']}" />
							<br />
							<h:inputText value="#{usermanagedbean.user.username}"
								required="true"
								requiredMessage="#{msg['error.validation.required']}"
								validatorMessage="#{msg['error.validation.mincharacter']}">
								<f:validateLength minimum="3" />
							</h:inputText>
						</h:column>

						<h:column>
							<h:outputLabel for="email" value="Email: " />
							<br />
							<p:inputText value="#{usermanagedbean.user.email}" />
						</h:column>
						<h:column>
							<h:outputLabel for="loyaltyindex"
								value="#{msg['web.user.loyalty']}" />
							<br />
							<h:inputText value="#{usermanagedbean.user.loyaltyIndex}"
								required="true"
								converterMessage="#{msg['error.validation.digitonly']}"
								requiredMessage="#{msg['error.validation.required']}"
								validatorMessage="#{msg['error.validation.numberpositive']}">
								<f:validateLongRange minimum="1" />
							</h:inputText>
						</h:column>
						<h:column>
							<h:outputLabel for="password" value="#{msg['web.user.password']}" />
							<br />
							<h:inputSecret id="passwordInput"
								value="#{usermanagedbean.user.password}" required="true"
								requiredMessage="#{msg['error.validation.required']}"
								validatorMessage="#{msg['error.validation.password']}">
								<f:validateRegex
									pattern="((?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%*+-]).{6,20})" />
							</h:inputSecret>
						</h:column>

						<h:column>

							<p:selectCheckboxMenu value="#{usermanagedbean.selectedRoles}"
								label="#{msg['web.role.header.roles']}">
								<f:selectItems value="#{rolemanagedbean.roles}" var="roles"
									itemValue="#{roles.id}" itemLabel="#{roles.rolename}" />

							</p:selectCheckboxMenu>
						</h:column>

						<h:column>

							<h:commandButton value="#{msg['web.user.add']}"
								action="#{usermanagedbean.insert()}" />

						</h:column>
					</p:panelGrid>


					<!-- ********************* -->
					<p:spacer height="30px;" />

					<p:dataTable id="userTable" value="#{usermanagedbean.allUsers}"
						var="u" widgetVar="50" editable="true">

						<f:facet name="header">  
                    #{msg['web.user.header.users']}
                    	</f:facet>

						<p:ajax event="rowEdit" listener="#{usermanagedbean.onEdit}"
							update=":form1:messages" />

						<p:ajax event="rowEditCancel"
							listener="#{usermanagedbean.onCancel}" update=":form1:messages" />

						<p:ajax event="rowEditInit"
							listener="#{usermanagedbean.onRowEditInit}" process="check"  />

						<p:column>
							<f:facet name="header">
								<h:outputText value="Item Name" />
							</f:facet>
							<p:cellEditor>
								<f:facet name="output">
									<h:outputText value="#{u.username}" />
								</f:facet>
								<f:facet name="input">
									<p:inputText value="#{u.username}" style="width:100%" />
								</f:facet>
							</p:cellEditor>
						</p:column>

						<p:column>
							<f:facet name="header">
								<h:outputText value="Email" />
							</f:facet>
							<p:cellEditor>
								<f:facet name="output">
									<h:outputText value="#{u.email}" />
								</f:facet>
								<f:facet name="input">
									<p:inputText value="#{u.email}" style="width:100%" />
								</f:facet>
							</p:cellEditor>
						</p:column>




						<p:column>
							<f:facet name="header">
								<h:outputText value="loyalty" />
							</f:facet>
							<p:cellEditor>
								<f:facet name="output">
									<h:outputText value="#{u.loyaltyIndex}" />
								</f:facet>
								<f:facet name="input">
									<p:inputText value="#{u.loyaltyIndex}" style="width:100%" />
								</f:facet>
							</p:cellEditor>

						</p:column>

						<p:column>
							<f:facet name="header">
								<h:outputText value="roles" />
							</f:facet>
							<p:cellEditor>
								<f:facet name="output">
									<ui:repeat value="#{u.roles}" var="r">
            						#{r.rolename} 
        						</ui:repeat>
								</f:facet>
								<f:facet name="input">
									<p:selectCheckboxMenu 
										value="#{usermanagedbean.selectedRoles(u)}"
										label="#{msg['web.role.header.roles']}">
										<f:selectItems value="#{rolemanagedbean.roles}" var="roles"
											itemValue="#{roles.rolename}" itemLabel="#{roles.rolename}" />

									</p:selectCheckboxMenu>
								</f:facet>
							</p:cellEditor>
						</p:column>



						<p:column headerText="Options" style="width:50px">
							<p:rowEditor />
							<p:commandButton action="#{usermanagedbean.delete(u)}"
								title="delete" icon="ui-icon-close" ajax="true"
								update="userTable" process="@this">
							</p:commandButton>
						</p:column>

					</p:dataTable>


					<!-- ********************* -->
				</p:panel>

			</h:form>
		</h:column>
	</h:panelGrid>
	<ui:include src="/includes/footer.xhtml" />
</h:body>

</html>